AWSTemplateFormatVersion: 2010-09-09
Description: Dance Party Stack
Parameters:
  DomainName:
    Type: String
    Default: dance-party.rossreicks.com
Resources:
  QueueRequestLambda:
    Type: AWS::Lambda::Function
    Properties: 
      Handler: index.handler
      FunctionName: dance-party-queue-request
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/dance-party-lambda-role
      Runtime: nodejs12.x
      Timeout: 5
      Code: 
        ZipFile: |
          exports.handler = function(event, context) { console.log("hello lambda") }

  S3Bucket:
    Type: AWS::S3::Bucket
    Properties: 
      BucketName: reicksross-dance-party-static-content

  BucketPolicy: 
    Type: AWS::S3::BucketPolicy
    Properties: 
      Bucket: 
        Ref: S3Bucket
      PolicyDocument: 
        Statement: 
          - 
            Action: 
              - "s3:GetObject"
            Effect: "Allow"
            Resource: 
              Fn::Join: 
                - ""
                - 
                  - "arn:aws:s3:::"
                  - 
                    Ref: S3Bucket
                  - "/*"
            Principal:
              AWS: !Sub arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${CloudFrontOriginAccessIdentity}
          

  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: oid to connect to s3

  CloudFront:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: True
        Aliases:
          - !Ref DomainName
        DefaultRootObject: index.html
        PriceClass: PriceClass_100
        ViewerCertificate:
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1
          AcmCertificateArn: !Ref Certificate
        DefaultCacheBehavior:
          TargetOriginId: s3-bucket
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
          CachedMethods:
            - GET
            - HEAD
          ForwardedValues:
            QueryString: True
        Origins:
          -
            DomainName: !GetAtt S3Bucket.DomainName
            Id: s3-bucket
            S3OriginConfig:
              OriginAccessIdentity: !Sub origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}

  DNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: Z0455587QPN9KHP9CHH1
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        HostedZoneId: Z2FDTNDATAQYW2
        DNSName: 
          !Join
            - ''
            - 
              - !GetAtt CloudFront.DomainName
              - '.'
  Certificate:
    Type: AWS::CertificateManager::Certificate
    Properties: 
      DomainName: !Ref DomainName
      ValidationMethod: DNS

          
